{% extends "base.html" %}

{% block title %}Crew Profile - {{ user.name }}{% endblock %}

{% block content %}
<style>
    /* Styles are now in style.css, but keeping this for quick reference if needed */
    /* It's better to have all styles in the external CSS file */
    .btn-primary {
        background-color: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        text-decoration: none;
        border: none;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    /* ensure charts have a predictable size so center text fits */
    .chart-card { width: 180px; height: 180px; display: inline-block; margin: 8px; }
    .chart-card canvas { width: 100% !important; height: 100% !important; }
</style>

<div class="profile-container">
    <div class="header">
        <h1>{{ user.name }}'s Crew Profile</h1>
        <a href="{{ url_for('home.edit_profile') }}" class="btn-details" style="margin-top: 1rem; display: inline-block;">Edit Profile</a>
    </div>

    <!-- Nutrition Status Section -->
    <div class="section">
        <div class="grid-container nutrition-grid">
            {% for nutrient, data in nutrition_progress.items() %}
            <div class="chart-card">
                <canvas id="chart-{{ nutrient }}"></canvas>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recommended Food Section -->
    <div class="section">
        <h2 class="section-title">Recommended Meals</h2>
        <div class="grid-container">
            {% for food in recommended_food %}
            <div class="food-card">
                <img src="{{ food.image }}" alt="{{ food.name }}">
                <h5>{{ food.name }}</h5>
                <a href="#" class="btn-details">Details</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Food Timeline Section -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 class="section-title">{% if session.get('lang','kor') == 'eng' %}Intake Log{% else %}섭취 기록{% endif %}</h2>
            <a href="{{ url_for('home.add_intake') }}" class="btn btn-primary">{% if session.get('lang','kor') == 'eng' %}Add Intake{% else %}섭취 기록 추가{% endif %}</a>
        </div>
        <div class="grid-container">
            <div class="timeline-card">
                <h4>Today</h4>
                {% if today_timeline and today_timeline.intake %}
                    {% for item in today_timeline.intake %}
                    <div class="timeline-item">
                        <span>{{ dish_map[item.dish_id].name[session.get('lang', 'kor')] if item.dish_id in dish_map else item.food_name }}</span>
                        <span>{{ item.time }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No intake recorded today.</p>
                {% endif %}
            </div>
            <div class="timeline-card">
                <h4>Yesterday</h4>
                {% if yesterday_timeline and yesterday_timeline.intake %}
                    {% for item in yesterday_timeline.intake %}
                    <div class="timeline-item">
                        <span>{{ dish_map[item.dish_id].name[session.get('lang', 'kor')] if item.dish_id in dish_map else item.food_name }}</span>
                        <span>{{ item.time }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No intake recorded yesterday.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Plugin to draw center text (percentage and amount) in doughnut charts
const centerTextPlugin = {
    id: 'centerTextPlugin',
    afterDraw: (chart) => {
        if (chart.config.type !== 'doughnut') return;
        const ctx = chart.ctx;
        const centerCfg = chart.config.options.plugins && chart.config.options.plugins.centerText;
        if (!centerCfg) return;
        
        const text1 = centerCfg.text1;
        const text2 = centerCfg.text2;

        ctx.save();
        
        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (text1) {
            const fontSize1 = centerCfg.fontSize1 || 20;
            ctx.font = `bold ${fontSize1}px ${centerCfg.fontFamily || 'Arial'}`;
            ctx.fillStyle = centerCfg.color1 || '#fff';
            // Position text1 slightly above center if text2 exists
            const y1 = text2 ? centerY - (fontSize1 / 2) : centerY;
            ctx.fillText(text1, centerX, y1);
        }

        if (text2) {
            const fontSize2 = centerCfg.fontSize2 || 14;
            ctx.font = `${fontSize2}px ${centerCfg.fontFamily || 'Arial'}`;
            ctx.fillStyle = centerCfg.color2 || '#ddd';
            // Position text2 slightly below center
            const y2 = text1 ? centerY + (fontSize2 / 2) + 5 : centerY;
            ctx.fillText(text2, centerX, y2);
        }

        ctx.restore();
    }
};
Chart.register(centerTextPlugin);

document.addEventListener("DOMContentLoaded", function() {
    const nutritionData = {{ nutrition_progress | tojson }};

    for (const nutrient in nutritionData) {
        const data = nutritionData[nutrient];
        const canvasId = 'chart-' + nutrient;
        const ctx = document.getElementById(canvasId).getContext('2d');

        const percent = Math.round(data.percentage);

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [nutrient, 'Remaining'],
                datasets: [{
                    data: [percent, 100 - percent > 0 ? 100 - percent : 0],
                    backgroundColor: ['#ffd835', '#6c35c4'],
                    borderColor: '#2e1c82',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `${nutrient.charAt(0).toUpperCase() + nutrient.slice(1)}`,
                        color: '#ffffff',
                        font: { size: 14, family: "Apple Braille" }
                    },
                    centerText: {
                        text1: `${percent}%`,
                        text2: `${data.total.toFixed(3)}${data.unit}`,
                        color1: '#ffffff',
                        fontSize1: 20,
                        color2: '#dddddd',
                        fontSize2: 14,
                        fontFamily: 'Apple Braille'
                    }
                },
                cutout: '70%'
            }
        });
    }
});
</script>
{% endblock %}