{% extends 'base.html' %}

{% block title %}{% if session.get('lang','kor') == 'eng' %}Add Dish{% else %}요리 추가{% endif %}{% endblock %}

{% block content %}
    <h1>{% if session.get('lang','kor') == 'eng' %}Add Dish{% else %}요리 (Dish) 추가{% endif %}</h1>
    <form method="POST">
        <label>{% if session.get('lang','kor') == 'eng' %}Name (multilingual):{% else %}이름 (다중 언어):{% endif %}</label><br>
        <div id="name-fields"></div>
        <button type="button" id="add-name-btn">{% if session.get('lang','kor') == 'eng' %}Add Name{% else %}이름 추가{% endif %}</button><br><br>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addNameField = createDynamicLanguageFields('name-fields', 'name', '이름');
            document.getElementById('add-name-btn').addEventListener('click', addNameField);

            const addCookingInstructionsField = createDynamicLanguageFields('cooking-instructions-fields', 'cooking_instructions', '조리 방법 설명');
            document.getElementById('add-cooking-instructions-btn').addEventListener('click', addCookingInstructionsField);
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('add-ingredient-btn');
            const select = document.getElementById('ingredient-select');
            const amt = document.getElementById('ingredient-amount');
            const container = document.getElementById('selected-ingredients');

            function addIngredientEntry() {
                const id = select.value;
                const selectedOption = select.options[select.selectedIndex];
                const idText = selectedOption.text;
                const itemType = selectedOption.getAttribute('data-type') || 'ingredient';
                const amountVal = amt.value ? parseFloat(amt.value) : 0;
                if (!id) return;

                const row = document.createElement('div');
                row.className = 'ingredient-row';
                row.textContent = `${idText} — ${amountVal} g `;

                const remove = document.createElement('button');
                remove.type = 'button';
                remove.textContent = '삭제';
                remove.addEventListener('click', () => { row.remove(); });

                // hidden inputs for type, id, and amount
                const hidType = document.createElement('input');
                hidType.type = 'hidden';
                hidType.name = 'item_types[]';
                hidType.value = itemType;
                
                const hidId = document.createElement('input');
                hidId.type = 'hidden';
                hidId.name = 'item_ids[]';
                hidId.value = id;
                
                const hidAmt = document.createElement('input');
                hidAmt.type = 'hidden';
                hidAmt.name = 'item_amounts[]';
                hidAmt.value = amountVal;

                row.appendChild(hidType);
                row.appendChild(hidId);
                row.appendChild(hidAmt);
                row.appendChild(remove);
                container.appendChild(row);

                amt.value = '';
            }

            addBtn.addEventListener('click', addIngredientEntry);
        });
    </script>

    <!-- dish_type removed per new DB format -->

        <label for="image_url">{% if session.get('lang','kor') == 'eng' %}Image URL:{% else %}이미지 URL:{% endif %}</label><br>
        <input type="text" id="image_url" name="image_url"><br><br>

        <label>{% if session.get('lang','kor') == 'eng' %}Required Items (ingredients or dishes + amount):{% else %}필요한 항목 (재료 또는 요리 + 사용량):{% endif %}</label><br>
        <div>
            <select id="ingredient-select">
                <optgroup label="{% if session.get('lang','kor') == 'eng' %}Ingredients{% else %}재료{% endif %}">
                    {% for ingredient in all_ingredients %}
                        <option value="{{ ingredient.id }}" data-type="ingredient">{{ ingredient.display_name }} (ID: {{ ingredient.id }})</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="{% if session.get('lang','kor') == 'eng' %}Dishes{% else %}요리{% endif %}">
                    {% for dish in all_dishes %}
                        <option value="{{ dish.id }}" data-type="dish">{{ dish.display_name }} (ID: {{ dish.id }})</option>
                    {% endfor %}
                </optgroup>
            </select>
            <input type="number" id="ingredient-amount" placeholder="{% if session.get('lang','kor') == 'eng' %}Amount (g){% else %}사용량(g){% endif %}" step="any" style="width:120px; margin-left:8px;">
            <button type="button" id="add-ingredient-btn">{% if session.get('lang','kor') == 'eng' %}Add{% else %}추가{% endif %}</button>
        </div>
        <div id="selected-ingredients" style="margin-top:8px;"></div>
        <!-- Hidden inputs will be created for item_types[], item_ids[], and item_amounts[] -->
        <br>

        <label for="required_cooking_method_ids">{% if session.get('lang','kor') == 'eng' %}Required Cooking Methods:{% else %}필요한 조리 방법:{% endif %}</label><br>
        <select id="required_cooking_method_ids" name="required_cooking_method_ids" multiple size="5">
            {% for method in all_cooking_methods %}
                <option value="{{ method.id }}">{{ method.display_name }} (ID: {{ method.id }})</option>
            {% endfor %}
        </select><br><small>{% if session.get('lang','kor') == 'eng' %}Hold Ctrl or Shift to select multiple items{% else %}Ctrl 또는 Shift 키를 눌러 다중 선택할 수 있습니다{% endif %}</small><br><br>

    {# calories input removed - backend will compute full nutrition automatically #}

        <label>{% if session.get('lang','kor') == 'eng' %}Cooking Instructions (multilingual):{% else %}조리 방법 설명 (다중 언어):{% endif %}</label><br>
        <div id="cooking-instructions-fields"></div>
        <button type="button" id="add-cooking-instructions-btn">{% if session.get('lang','kor') == 'eng' %}Add Cooking Instructions{% else %}조리 방법 설명 추가{% endif %}</button><br><br>

        <button type="submit">{% if session.get('lang','kor') == 'eng' %}Add{% else %}추가하기{% endif %}</button>
    </form>
{% endblock %}
