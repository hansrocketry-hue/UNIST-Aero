{% extends 'base.html' %}

{% block title %}{% if session.get('lang','kor') == 'eng' %}Data Visualization{% else %}데이터 시각화{% endif %}{% endblock %}

{% block content %}
<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    th, td {
        border-bottom: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    tr:hover {background-color: #f5f5f5;}
    th {
        background-color: #f2f2f2;
    }
</style>
    <h1>{% if session.get('lang','kor') == 'eng' %}Data Visualization{% else %}데이터 시각화{% endif %}</h1>
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                border-bottom: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            tr:hover {background-color: #f5f5f5;}
            th {
                background-color: #f2f2f2;
            }
            .category-btns {
                margin-bottom: 20px;
            }
            .category-btns button {
                margin-right: 10px;
                padding: 8px 16px;
                border: none;
                background: #e0e0e0;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            }
            .category-btns button.active {
                background: #1976d2;
                color: #fff;
            }
            .category-table {
                display: none;
            }
            #search-bar {
                margin-bottom: 20px;
                padding: 8px;
                width: 300px;
                font-size: 16px;
            }
        </style>

        <div class="category-btns">

            <button type="button" class="active" onclick="showCategory('research')">{% if session.get('lang','kor') == 'eng' %}Research Data{% else %}연구자료{% endif %}</button>
            <button type="button" onclick="showCategory('ingredient')">{% if session.get('lang','kor') == 'eng' %}Ingredients{% else %}식재료{% endif %}</button>
            <button type="button" onclick="showCategory('cooking')">{% if session.get('lang','kor') == 'eng' %}Cooking Methods{% else %}조리방법{% endif %}</button>
            <button type="button" onclick="showCategory('dish')">{% if session.get('lang','kor') == 'eng' %}Dishes{% else %}요리{% endif %}</button>
        </div>
        <div style="margin-bottom:20px;">
            <input type="text" id="search-bar" placeholder="{% if session.get('lang','kor') == 'eng' %}Enter search term...{% else %}검색어를 입력하세요...{% endif %}" style="margin-right:8px;" onkeydown="if(event.key==='Enter'){filterTable();}">
            <button type="button" onclick="filterTable()">{% if session.get('lang','kor') == 'eng' %}Search{% else %}검색{% endif %}</button>
        </div>

        <div id="category-research" class="category-table">
            <h2>{% if session.get('lang','kor') == 'eng' %}Research Data{% else %}연구 자료{% endif %}</h2>
            <table>
                <thead>
                    <tr>
                        <th>{% if session.get('lang','kor') == 'eng' %}Title{% else %}제목{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Link{% else %}링크{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Summary{% else %}요약{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data['research-data'] %}
                    <tr>
                        <td><a href="{{ url_for('visualize.research_detail', research_id=item.id) }}">{{ item.reference_data.title }}</a></td>
                        <td><a href="{{ item.reference_data.link }}" target="_blank">{{ item.reference_data.link }}</a></td>
                        <td>{{ item.summary[session.get('lang', 'kor')] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="category-ingredient" class="category-table">
            <h2>{% if session.get('lang','kor') == 'eng' %}Ingredients{% else %}식재료{% endif %}</h2>
            <table>
                <thead>
                    <tr>
                        <th>{% if session.get('lang','kor') == 'eng' %}Name{% else %}이름{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Research IDs{% else %}연구 ID{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Calories{% else %}칼로리{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Production Time{% else %}생산 시간{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data['ingredient'] %}
                    <tr>
                        <td><a href="{{ url_for('visualize.ingredient_detail', ingredient_id=item.id) }}">{{ item.name[session.get('lang', 'kor')] }}</a></td>
                        <td>
                            {% for research_id in item.research_ids %}
                                {% for research in data['research-data'] %}
                                    {% if research.id == research_id %}
                                        <a href="{{ url_for('visualize.research_detail', research_id=research_id) }}">{{ research.reference_data.title }}</a><br>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </td>
                        <td>
                            {# Safe extraction of calories from different possible data shapes #}
                            {% set _cal = '' %}
                            {% if item.nutrition_info is defined and item.nutrition_info %}
                                {% if item.nutrition_info is mapping %}
                                    {% if 'calories' in item.nutrition_info %}
                                        {% set _cal = item.nutrition_info['calories'] %}
                                    {% elif 'Calories (Total)' in item.nutrition_info %}
                                        {% set _cal = item.nutrition_info['Calories (Total)'] %}
                                    {% endif %}
                                {% elif item.nutrition_info is sequence %}
                                    {% for nut in item.nutrition_info %}
                                                {% if nut is mapping %}
                                                    {% set nut_name = (nut.get('name') or nut.get('label') or '') %}
                                                    {% if not _cal and nut_name in ['Calories (Total)', 'Calories', 'calories'] %}
                                                        {% set _cal = (nut.get('amount_per_unit_mass') or nut.get('amount_per_dish') or nut.get('amount') or '') %}
                                                    {% endif %}
                                                {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                            {{ _cal if _cal else 'N/A' }}
                        </td>
                        <td>
                            {# Friendly display for production_time which may be dict or simple value #}
                            {% if item.production_time is defined and item.production_time %}
                                {% if item.production_time is mapping %}
                                    {% if 'producible' in item.production_time and item.production_time.producible %}
                                        {{ item.production_time.min }}~{{ item.production_time.max }}일
                                    {% elif 'producible' in item.production_time and not item.production_time.producible %}
                                        생산 불가
                                    {% else %}
                                        {{ item.production_time }}
                                    {% endif %}
                                {% else %}
                                    {{ item.production_time }}
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="category-cooking" class="category-table">
            <h2>{% if session.get('lang','kor') == 'eng' %}Cooking Methods{% else %}조리 방법{% endif %}</h2>
            <table>
                <thead>
                    <tr>
                        <th>{% if session.get('lang','kor') == 'eng' %}Name{% else %}이름{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Description{% else %}설명{% endif %}</th>
                        <th>{% if session.get('lang','kor') == 'eng' %}Research IDs{% else %}연구 ID{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data['cooking-methods'] %}
                    <tr>
                        <td><a href="{{ url_for('visualize.cooking_method_detail', method_id=item.id) }}">{{ item.name[session.get('lang', 'kor')] }}</a></td>
                        <td>{{ item.description[session.get('lang', 'kor')] }}</td>
                        <td>
                            {% for research_id in item.research_ids %}
                                {% for research in data['research-data'] %}
                                    {% if research.id == research_id %}
                                        <a href="{{ url_for('visualize.research_detail', research_id=research_id) }}">{{ research.reference_data.title }}</a><br>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="category-dish" class="category-table">
            <h2>{% if session.get('lang','kor') == 'eng' %}Dishes{% else %}요리{% endif %}</h2>
            <table>
                <thead>
                    <tr>
                        <th>{% if session.get('lang','kor') == 'eng' %}Name{% else %}이름{% endif %}</th>
                        <th>Required Ingredients</th>
                        <th>Required Cooking Methods</th>
                        <th>Calories</th>
                        <th>Cooking Instructions (kor)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data['dish'] %}
                    <tr>
                        <td>
                            <a href="{{ url_for('visualize.dish_detail', dish_id=item.id) }}" class="btn btn-sm {% if item.name is mapping and item.name.get(session.get('lang', 'kor')) %}btn-outline-primary{% else %}btn-primary{% endif %}">
                                {% if item.name is mapping %}
                                    {{ item.name[session.get('lang', 'kor')] }}
                                {% elif item.name is string %}
                                    {{ item.name }}
                                {% else %}
                                    {% if session.get('lang','kor') == 'eng' %}View Details{% else %}상세 보기{% endif %}
                                {% endif %}
                            </a>
                        </td>
                        <td>
                            {# New schema: required_ingredients is list of {id, amount_g}. Keep fallback for legacy required_ingredient_ids. #}
                            {% if item.required_ingredients is defined %}
                                {% for req in item.required_ingredients %}
                                    {% set ing_id = req.id if req.id is defined else req.get('id') %}
                                    {% set amt = req.amount_g if req.amount_g is defined else req.get('amount_g') %}
                                    {% for ingredient in data['ingredient'] %}
                                        {% if ingredient.id == ing_id %}
                                            <a href="{{ url_for('visualize.ingredient_detail', ingredient_id=ing_id) }}">{{ ingredient.name[session.get('lang', 'kor')] }}</a>
                                            {% if amt %} — {{ amt }} g{% endif %}
                                            <br>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% elif item.required_ingredient_ids is defined %}
                                {% for ing_id in item.required_ingredient_ids %}
                                    {% for ingredient in data['ingredient'] %}
                                        {% if ingredient.id == ing_id %}
                                            <a href="{{ url_for('visualize.ingredient_detail', ingredient_id=ing_id) }}">{{ ingredient.name[session.get('lang', 'kor')] }}</a><br>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td>
                            {% set method_ids = item['cooking-method-ids'] if 'cooking-method-ids' in item else [] %}
                            {% for method_id in method_ids %}
                                {% for method in data['cooking-methods'] %}
                                    {% if method.id == method_id %}
                                        <a href="{{ url_for('visualize.cooking_method_detail', method_id=method_id) }}">{{ method.name[session.get('lang', 'kor')] }}</a><br>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </td>
                        <td>
                            {% set ns = namespace(calo=0) %}
                            {% if item['nutrition_info'] %}
                                {% for nut in item['nutrition_info'] %}
                                    {% if 'name' in nut and nut['name'] == 'Calories (Total)' and 'amount_per_dish' in nut %}
                                        {% set ns.calo = nut['amount_per_dish'] %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            {{ ns.calo }}
                        </td>
                        <td>
                            {% if item.cooking_instructions is string %}
                                {{ item.cooking_instructions }}
                            {% elif item.cooking_instructions.kor is defined %}
                                {{ item.cooking_instructions.kor }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script>
        function showCategory(cat) {
            const cats = ['research', 'ingredient', 'cooking', 'dish'];
            cats.forEach(c => {
                var div = document.getElementById('category-' + c);
                if (div) div.style.display = 'none';
                var btn = document.querySelector('.category-btns button[onclick*="' + c + '"]');
                if (btn) btn.classList.remove('active');
            });
            var activeDiv = document.getElementById('category-' + cat);
            if (activeDiv) activeDiv.style.display = 'block';
            var activeBtn = document.querySelector('.category-btns button[onclick*="' + cat + '"]');
            if (activeBtn) activeBtn.classList.add('active');
            document.getElementById('search-bar').value = '';
            filterTable();
        }

        window.addEventListener('DOMContentLoaded', function() {
            showCategory('research');
        });

        function filterTable() {
            const search = document.getElementById('search-bar').value.toLowerCase();
            const cats = ['research', 'ingredient', 'cooking', 'dish'];
            let activeCat = cats.find(cat => document.getElementById('category-' + cat).style.display === 'block');
            if (!activeCat) return;
            const tableDiv = document.getElementById('category-' + activeCat);
            const trs = tableDiv.querySelectorAll('tbody tr');
            trs.forEach(tr => {
                let titleText = '';
                if (activeCat === 'research') {
                    // 1st column: Title
                    let td = tr.querySelector('td');
                    titleText = td ? td.textContent.toLowerCase() : '';
                } else if (activeCat === 'ingredient') {
                    // 1st column: Name (kor)
                    let td = tr.querySelector('td');
                    titleText = td ? td.textContent.toLowerCase() : '';
                } else if (activeCat === 'cooking') {
                    // 1st column: Name (kor)
                    let td = tr.querySelector('td');
                    titleText = td ? td.textContent.toLowerCase() : '';
                } else if (activeCat === 'dish') {
                    // 1st column: Name (kor)
                    let td = tr.querySelector('td');
                    titleText = td ? td.textContent.toLowerCase() : '';
                }
                tr.style.display = titleText.includes(search) ? '' : 'none';
            });
        }
        </script>
        {% endblock %}
