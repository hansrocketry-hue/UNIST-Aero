{% extends "base.html" %}

{% block title %}Crew Profile - {{ user.name }}{% endblock %}

{% block content %}
<style>
    /* Styles are now in style.css, but keeping this for quick reference if needed */
    /* It's better to have all styles in the external CSS file */
    .btn-primary {
        background-color: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        text-decoration: none;
        border: none;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
</style>

<div class="profile-container">
    <div class="header">
        <h1>{{ user.name }}'s Crew Profile</h1>
        <a href="{{ url_for('home.edit_profile') }}" class="btn-details" style="margin-top: 1rem; display: inline-block;">Edit Profile</a>
    </div>

    <!-- Nutrition Status Section -->
    <div class="section">
        <div class="grid-container nutrition-grid">
            {% for nutrient, data in nutrition_progress.items() %}
            <div class="chart-card">
                <canvas id="chart-{{ nutrient }}"></canvas>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recommended Food Section -->
    <div class="section">
        <h2 class="section-title">Recommended Meals</h2>
        <div class="grid-container">
            {% for food in recommended_food %}
            <div class="food-card">
                <img src="{{ food.image }}" alt="{{ food.name }}">
                <h5>{{ food.name }}</h5>
                <a href="#" class="btn-details">Details</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Food Timeline Section -->
    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 class="section-title">{% if session.get('lang','kor') == 'eng' %}Intake Log{% else %}섭취 기록{% endif %}</h2>
            <a href="{{ url_for('home.add_intake') }}" class="btn btn-primary">{% if session.get('lang','kor') == 'eng' %}Add Intake{% else %}섭취 기록 추가{% endif %}</a>
        </div>
        <div class="grid-container">
            <div class="timeline-card">
                <h4>Today</h4>
                {% if today_timeline and today_timeline.intake %}
                    {% for item in today_timeline.intake %}
                    <div class="timeline-item">
                        <span>{{ dish_map[item.dish_id].name[session.get('lang', 'kor')] if item.dish_id in dish_map else item.food_name }}</span>
                        <span>{{ item.time }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No intake recorded today.</p>
                {% endif %}
            </div>
            <div class="timeline-card">
                <h4>Yesterday</h4>
                {% if yesterday_timeline and yesterday_timeline.intake %}
                    {% for item in yesterday_timeline.intake %}
                    <div class="timeline-item">
                        <span>{{ dish_map[item.dish_id].name[session.get('lang', 'kor')] if item.dish_id in dish_map else item.food_name }}</span>
                        <span>{{ item.time }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No intake recorded yesterday.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const nutritionData = {{ nutrition_progress | tojson }};
    
    for (const nutrient in nutritionData) {
        const data = nutritionData[nutrient];
        const ctx = document.getElementById('chart-' + nutrient).getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [nutrient, 'Remaining'],
                datasets: [{
                    data: [data.percentage, 100 - data.percentage > 0 ? 100 - data.percentage : 0],
                    backgroundColor: ['#ffd835', '#6c35c4'],
                    borderColor: '#2e1c82',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `${nutrient.charAt(0).toUpperCase() + nutrient.slice(1)}`,
                        color: '#ffffff',
                        font: { size: 16, family: "Apple Braille" }
                    }
                },
                cutout: '70%'
            }
        });
    }
});
</script>
{% endblock %}